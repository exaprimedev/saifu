<!doctype html>
<html lang="ja">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <style>
        html,
        body {
            font-size: small;
            height: 100%;
            margin: 0;
        }
        
        .wrapper {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .header,
        .content {
            flex: 1;
            overflow: auto;
        }
    </style>
    <title>saifu</title>
</head>

<body>
    <div class="wrapper">
        <div class="header">
            <div class="card w-100">
                <div class="card-header" style="padding:.3rem 1rem;">
                    <strong>
                        <span id="bakaze">東</span><span id="kyoku">1</span>局：<span id="honba">0</span>本場：ドラ：<img
                            style="width:14px;height:auto;" src="imgs/p2.png">
                    </strong>
                </div>
                <div class="card-body text-left" style="transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg);">
                    <span id="oya">東</span>家：丸山まるこ
                    <div id="kawa" class="w-100" style="text-align: left;">
                    </div>
                </div>
            </div>
            <div id="tehai" style="margin-bottom:-15px;">
            </div>
        </div>
        <div class="content">
            <div style="height:1000px;">
                <input type="hidden" id="hid_tehai" name="hid_tehai">
                <input type="hidden" id="hid_furo" name="hid_furo">
                <input type="hidden" id="hid_tatsu" name="hid_tatsu">
                <input type="hidden" id="hid_status" name="hid_status" value="haipai">
                <input type="hidden" id="hid_jyunme" name="hid_jyunme" value="1">
                <div id="history" style="margin-bottom:-15px;">
                </div>
                <div class="modal" tabindex="-1" role="dialog" id="tehai_confirm_modal">
                    <div class="modal-dialog modal-dialog-centered" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">配牌確認</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="閉じる">
                                    <span aria-hidden="true">×</span>
                                </button>
                            </div>
                            <div class="modal-body" id="tehai_confirm_modal_body">
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="modalOK()">OK</button>
                                <button type="button" class="btn btn-secondary" id="modal_close" onclick="modalClear()">クリア</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal" tabindex="-1" role="dialog" id="naki_confirm_modal">
                    <div class="modal-dialog modal-dialog-centered" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">副露確認</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="閉じる">
                                    <span aria-hidden="true">×</span>
                                </button>
                            </div>
                            <div class="modal-body" id="naki_confirm_modal_body">
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" id="naki_confirm_modal_cancel" onclick="furoCancel()">キャンセル</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer">
            <div class="card w-100">
                <div class="collapse" id="keyboard">
                    <div id="keyboard_m" class="w-100" style="text-align: center;">
                    </div>
                    <div id="keyboard_p" class="w-100" style="text-align: center;">
                    </div>
                    <div id="keyboard_s" class="w-100" style="text-align: center;">
                    </div>
                    <div id="keyboard_z" class="w-100" style="text-align: center;">
                    </div>
                </div>
                <div class="btn-group d-flex" role="group" aria-label="...">
                    <button type="button" class="btn btn-outline-primary w-100"><strong>立直</strong></button>
                    <button type="button" class="btn btn-outline-danger w-100"><strong>副露</strong></button>
                    <button type="button" class="btn btn-outline-success w-100"><strong>和了/放銃</strong></button>
                    <button type="button" class="btn btn-outline-secondary w-100" data-toggle="collapse" data-target="#keyboard" aria-expanded="true" aria-controls="collapseKeyboard"><strong>キーボード</strong></button>
                </div>
            </div>
        </div>
    </div>
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin=" anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    ‘
    <!-- Optional JavaScript -->
    <script>
        const tatsuM = [{
            "pai": "m1",
            "tatsu": "m2,m3"
        }, {
            "pai": "m2",
            "tatsu": "m1,m3"
        }, {
            "pai": "m2",
            "tatsu": "m3,m4"
        }, {
            "pai": "m3",
            "tatsu": "m1,m2"
        }, {
            "pai": "m3",
            "tatsu": "m2,m4"
        }, {
            "pai": "m3",
            "tatsu": "m4,m5"
        }, {
            "pai": "m4",
            "tatsu": "m2,m3"
        }, {
            "pai": "m4",
            "tatsu": "m3,m5"
        }, {
            "pai": "m4",
            "tatsu": "m5,m6"
        }, {
            "pai": "m5",
            "tatsu": "m3,m4"
        }, {
            "pai": "m5",
            "tatsu": "m4,m6"
        }, {
            "pai": "m5",
            "tatsu": "m6,m7"
        }, {
            "pai": "m6",
            "tatsu": "m4,m5"
        }, {
            "pai": "m6",
            "tatsu": "m5,m7"
        }, {
            "pai": "m6",
            "tatsu": "m7,m8"
        }, {
            "pai": "m7",
            "tatsu": "m5,m6"
        }, {
            "pai": "m7",
            "tatsu": "m6,m8"
        }, {
            "pai": "m7",
            "tatsu": "m8,m9"
        }, {
            "pai": "m8",
            "tatsu": "m6,m7"
        }, {
            "pai": "m8",
            "tatsu": "m7,m9"
        }, {
            "pai": "m9",
            "tatsu": "m7,m8"
        }, {
            "pai": "p1",
            "tatsu": "p2,p3"
        }, {
            "pai": "p2",
            "tatsu": "p1,p3"
        }, {
            "pai": "p2",
            "tatsu": "p3,p4"
        }, {
            "pai": "p3",
            "tatsu": "p1,p2"
        }, {
            "pai": "p3",
            "tatsu": "p2,p4"
        }, {
            "pai": "p3",
            "tatsu": "p4,p5"
        }, {
            "pai": "p4",
            "tatsu": "p2,p3"
        }, {
            "pai": "p4",
            "tatsu": "p3,p5"
        }, {
            "pai": "p4",
            "tatsu": "p5,p6"
        }, {
            "pai": "p5",
            "tatsu": "p3,p4"
        }, {
            "pai": "p5",
            "tatsu": "p4,p6"
        }, {
            "pai": "p5",
            "tatsu": "p6,p7"
        }, {
            "pai": "p6",
            "tatsu": "p4,p5"
        }, {
            "pai": "p6",
            "tatsu": "p5,p7"
        }, {
            "pai": "p6",
            "tatsu": "p7,p8"
        }, {
            "pai": "p7",
            "tatsu": "p5,p6"
        }, {
            "pai": "p7",
            "tatsu": "p6,p8"
        }, {
            "pai": "p7",
            "tatsu": "p8,p9"
        }, {
            "pai": "p8",
            "tatsu": "p6,p7"
        }, {
            "pai": "p8",
            "tatsu": "p7,p9"
        }, {
            "pai": "p9",
            "tatsu": "p7,p8"
        }, {
            "pai": "s1",
            "tatsu": "s2,s3"
        }, {
            "pai": "s2",
            "tatsu": "s1,s3"
        }, {
            "pai": "s2",
            "tatsu": "s3,s4"
        }, {
            "pai": "s3",
            "tatsu": "s1,s2"
        }, {
            "pai": "s3",
            "tatsu": "s2,s4"
        }, {
            "pai": "s3",
            "tatsu": "s4,s5"
        }, {
            "pai": "s4",
            "tatsu": "s2,s3"
        }, {
            "pai": "s4",
            "tatsu": "s3,s5"
        }, {
            "pai": "s4",
            "tatsu": "s5,s6"
        }, {
            "pai": "s5",
            "tatsu": "s3,s4"
        }, {
            "pai": "s5",
            "tatsu": "s4,s6"
        }, {
            "pai": "s5",
            "tatsu": "s6,s7"
        }, {
            "pai": "s6",
            "tatsu": "s4,s5"
        }, {
            "pai": "s6",
            "tatsu": "s5,s7"
        }, {
            "pai": "s6",
            "tatsu": "s7,s8"
        }, {
            "pai": "s7",
            "tatsu": "s5,s6"
        }, {
            "pai": "s7",
            "tatsu": "s6,s8"
        }, {
            "pai": "s7",
            "tatsu": "s8,s9"
        }, {
            "pai": "s8",
            "tatsu": "s6,s7"
        }, {
            "pai": "s8",
            "tatsu": "s7,s9"
        }, {
            "pai": "s9",
            "tatsu": "s7,s8"
        }];
        const tagKeyboard1 = '<div style="float:left;" data-toggle="tooltip" title="';
        const tagKeyboard2 = '"><a href="#" id="';
        const tagKeyboard3 = '" onclick="selectPai(this)"><img id="img_';
        const tagStyle1 = '" style="width:';
        const tagStyle2 = 'px;height:auto;" src="imgs/';
        const tagKeyboard4 = '.png"></a></div>';
        var w = 0;
        var keyboard_w = 0;
        var tehai_w = 0;
        var tehai_w_h = 0;
        var kawa_w = 0;
        var kawa_w_h = 0;
        var arr_tehai = [];
        $(function() {
            w = $(window).width();
            keyboard_w = w * 0.099;
            tehai_w = w * 0.062;
            tehai_w_h = w * 0.085;
            kawa_w = w * 0.041;
            kawa_w_h = w * 0.085;
            var keyboard_m_out = "";
            var keyboard_p_out = "";
            var keyboard_s_out = "";
            var keyboard_z_out = "";
            for (var idx = 1; idx < 10; idx++) {
                keyboard_m_out += tagKeyboard1 + 'm' + idx + tagKeyboard2 + 'm' + idx + tagKeyboard3 + 'm' + idx + tagStyle1 + keyboard_w + tagStyle2 + 'm' + idx + tagKeyboard4;
                keyboard_p_out += tagKeyboard1 + 'p' + idx + tagKeyboard2 + 'p' + idx + tagKeyboard3 + 'p' + idx + tagStyle1 + keyboard_w + tagStyle2 + 'p' + idx + tagKeyboard4;
                keyboard_s_out += tagKeyboard1 + 's' + idx + tagKeyboard2 + 's' + idx + tagKeyboard3 + 's' + idx + tagStyle1 + keyboard_w + tagStyle2 + 's' + idx + tagKeyboard4;
            }
            keyboard_m_out += tagKeyboard1 + 'm5r' + tagKeyboard2 + 'm5r' + tagKeyboard3 + 'm' + idx + tagStyle1 + keyboard_w + tagStyle2 + 'm5r' + tagKeyboard4;
            keyboard_p_out += tagKeyboard1 + 'p5r' + tagKeyboard2 + 'p5r' + tagKeyboard3 + 'p' + idx + tagStyle1 + keyboard_w + tagStyle2 + 'p5r' + tagKeyboard4;
            keyboard_s_out += tagKeyboard1 + 's5r' + tagKeyboard2 + 's5r' + tagKeyboard3 + 's' + idx + tagStyle1 + keyboard_w + tagStyle2 + 's5r' + tagKeyboard4;
            for (var idx = 1; idx < 8; idx++) {
                keyboard_z_out += tagKeyboard1 + 'z' + idx + tagKeyboard2 + 'z' + idx + tagKeyboard3 + 'z' + idx + tagStyle1 + keyboard_w + tagStyle2 + 'z' + idx + tagKeyboard4;
            }
            $("#keyboard_m").html(keyboard_m_out);
            $("#keyboard_p").html(keyboard_p_out);
            $("#keyboard_s").html(keyboard_s_out);
            $("#keyboard_z").html(keyboard_z_out);
            $('[data-toggle="tooltip"]').tooltip();
        });

        function selectPai(elm) {
            var naki = "";
            var tehai = $("#tehai").html();
            var kawa = $("#kawa").html();
            var history = $("#history").html();
            if ($("#hid_status").val() == "haipai") {
                if (arr_tehai.length <= 13) {
                    arr_tehai.push(elm.id)
                    tehai += elm.innerHTML.replace(keyboard_w, tehai_w);
                    $("#tehai").html(tehai);
                    if (arr_tehai.length == 13) {
                        $("#tehai_confirm_modal_body").html($("#tehai").html());
                        $("#tehai_confirm_modal").modal();
                    }
                    $("#hid_tehai").val(arr_tehai.join());
                }
            } else if ($("#hid_status").val() == "furo") {
                var arr_naki = checkNaki(elm.id);
                if (arr_naki.length > 0) {
                    for (var idx in arr_naki) {
                        var arr_naki_row = arr_naki[idx].split(',');
                        naki += '<div>'
                        naki += '<div style="display:flex;margin-bottom:-15px;"><a href="#" onclick="furoPai(this,\'' + arr_naki[idx] + '\')">'
                        for (var idx in arr_naki_row) {
                            if (idx == 0) {
                                naki += arr_naki_row[arr_naki_row.length - 1];
                            }
                            naki += '<figure style="display:inline-block;">';
                            if (idx != arr_naki_row.length - 1) {
                                if (arr_naki_row[idx].indexOf("_h") !== -1) {
                                    naki += '<img id="img_' + arr_naki_row[idx] + tagStyle1 + tehai_w_h + tagStyle2 + arr_naki_row[idx] + '.png">'
                                } else {
                                    naki += '<img id="img_' + arr_naki_row[idx] + tagStyle1 + tehai_w + tagStyle2 + arr_naki_row[idx] + '.png">'
                                }
                            }
                            naki += '</figure>';
                        }
                        naki += '</a></div>'
                        naki += '</div>'
                        console.log(arr_naki[idx]);
                    }
                    $("#naki_confirm_modal_body").html(naki);
                    $("#naki_confirm_modal").modal();
                }
            } else if ($("#hid_status").val() == "tsumo") {
                arr_tehai.push(elm.id);
                var jyunme = $("#hid_jyunme").val();
                tehai += '<figure id="fig_' + $("#hid_jyunme").val() + "_" + elm.id + '" style="display:inline-block;">';
                tehai += elm.innerHTML.replace(keyboard_w, tehai_w);
                tehai += '</figure>';
                $("#hid_jyunme").val(Number(jyunme) + 1);
                $("#tehai").html(tehai);
                changeStatus("kiri");
                $("#hid_tehai").val(arr_tehai.join());
            } else {
                arr_tehai = $("#hid_tehai").val().split(',');
                arr_tehai.splice($.inArray(elm.id, arr_tehai), 1);
                $("#history").html('<div style="display:flex;margin-bottom:-15px;">' + $("#tehai").html() + "</div>" + history);
                $("#hid_tehai").val(arr_tehai.join());
                $("#tehai").html(sortTehai(elm.id));
                $("#fig_" + String(Number($("#hid_jyunme").val()) - 1) + "_" + elm.id).css({
                    'display': 'inline-block',
                    'filter': 'brightness(60%)'
                });
                var markKawa = '<figure style="display:inline-block;">'
                $("#kawa").html(kawa + markKawa + elm.innerHTML.replace(keyboard_w, kawa_w) + '<figcaption id="k_figc_' + String(Number($("#hid_jyunme").val()) - 1) + "_" + elm.id + '" style="text-align:center;font-size:80%;"></figcaption></figure>');
                $("#k_figc_" + String(Number($("#hid_jyunme").val()) - 1) + "_" + elm.id).html("");
                changeStatus("tsumo");
            }
        }

        function furoPai(elm, value) {
            $("#hid_furo").val(value.split(",").splice(0, value.split(",").length - 1).join());
            console.log(elm.innerHTML);
            console.log(value);
        }

        function modalOK() {
            $("#tehai_confirm_modal").modal('hide');
            $("#tehai").html(sortTehai());
            $("#hid_status").val("tsumo");
        }

        function modalClear() {
            $("#tehai").html("");
            $("#hid_tehai").val("");
            arr_tehai = [];
            $("#tehai_confirm_modal").modal('hide');
        }

        function furoCancel() {
            $("#naki_confirm_modal_cancel").modal('hide');
        }

        function sortTehai(pai) {
            arr_tehai = $("#hid_tehai").val().split(',');
            arr_tehai.sort();
            var tehai = "";
            for (var idx in arr_tehai) {
                tehai += '<figure style="display:inline-block;">';
                tehai += '<img id="img_' + arr_tehai[idx] + tagStyle1 + keyboard_w + tagStyle2 + arr_tehai[idx] + '.png">';
                tehai += '<figcaption id="figc_' + $("#hid_jyunme").val() + "_" + arr_tehai[idx] + '" style="text-align:center;font-size:80%;">'
                tehai += '</figcaption></figure>';
            }
            return tehai.split(keyboard_w).join(tehai_w);
        }

        function checkNaki(pai) {
            $("#naki_confirm_modal_body").html("");
            var result = [];
            var kotsu = ($("#hid_tehai").val().match(new RegExp(pai, "g")) || []);
            if (kotsu.length >= 2) {
                if (kotsu.length == 3) {
                    result.push(kotsu.join() + "," + pai + ",アンカン");
                    result.push(kotsu[0] + "_h," + kotsu[1] + "," + kotsu[2] + "," + pai + ",ミンカン");
                    result.push(kotsu[0] + "," + kotsu[1] + "_h," + kotsu[2] + "," + pai + ",ミンカン");
                    result.push(kotsu[0] + "," + kotsu[1] + "," + kotsu[2] + "," + pai + "_h,ミンカン");
                    result.push(kotsu[0] + "_h," + kotsu[1] + "," + kotsu[2] + ",ポン");
                    result.push(kotsu[0] + "," + kotsu[1] + "_h," + kotsu[2] + ",ポン");
                    result.push(kotsu[0] + "," + kotsu[1] + "," + kotsu[2] + "_h,ポン");
                }
                if (kotsu.length == 2) {
                    result.push(kotsu[0] + "_h," + kotsu[1] + "," + pai + ",ポン");
                    result.push(kotsu[0] + "," + kotsu[1] + "_h," + pai + ",ポン");
                    result.push(kotsu[0] + "," + kotsu[1] + "," + pai + "_h,ポン");
                }
            }
            var arr_tatsu = findTatsu(tatsuM, "pai", pai);
            for (var idx in arr_tatsu) {
                var arr_tatsu_row = arr_tatsu[idx].tatsu.split(',');
                if ($("#hid_tehai").val().indexOf(arr_tatsu_row[0]) > -1 && $("#hid_tehai").val().indexOf(arr_tatsu_row[1]) > -1) {
                    result.push(pai + "_h," + arr_tatsu[idx].tatsu + ",チー");
                }
            }
            return result;
        }

        function findTatsu(obj, key, value) {
            var result = $.grep(obj, function(e) {
                return e[key] == value;
            });
            return result;
        }

        function changeStatus(status) {
            $("#hid_status").val(status);
        }
    </script>
</body>

</html>